name: CI

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main

jobs:
  build_linux:
    name: Build App (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - run: |
          sudo apt-get update -y
          sudo apt-get install -y ninja-build libgtk-3-dev
      - run: flutter build linux
      - uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: build/linux/x64/release/bundle

  build_windows:
    name: Build App (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - run: flutter build windows
      - uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: build\windows\x64\runner\Release
  
  build_windows_installer:
    name: Build Installer (Windows)
    runs-on: windows-latest
    needs: [build_windows]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v5
        with:
          name: windows-build
          path: D:\combat-tracker\ReleaseFiles\
      - name: Compile .ISS to .EXE Installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.2
        with:
          path: windows/installer/installer.iss
          options: /O+
      - uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: D:\combat-tracker\Installer\Combat Tracker Setup.exe
  
  build_macos:
    name: Build App (macos)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - run: flutter build macos
      - uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: build/macos/Build/Products/Release/combat_tracker.app
  
  release:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs: [build_windows_installer, build_linux]
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Extract tag name and message into a file
      id: extract
      run: |
        set -euo pipefail
        TAG=${GITHUB_REF#refs/tags/}
        echo "Tag: $TAG"

        # Make sure the annotated tag object is present locally
        git fetch --depth=1 origin "refs/tags/$TAG:refs/tags/$TAG" || true

        # Try to read the annotated tag contents (the tag message)
        BODY=$(git for-each-ref --format='%(contents)' refs/tags/"$TAG" || true)

        # Fallback: if no annotated tag body, try the tag object or the commit message
        if [ -z "$BODY" ]; then
          BODY=$(git show -s --format=%B "refs/tags/$TAG" 2>/dev/null || git log -1 --pretty=%B)
        fi

        # Write body to file and to step output for convenience
        printf "%s" "$BODY" > release-body.md

        echo "Tag: $TAG"
        echo "Body:"
        echo $BODY
    - uses: actions/download-artifact@v5
      with:
        name: windows-installer
        path: windows-installer
    - uses: actions/download-artifact@v5
      with:
        name: linux-build
        path: linux-build
    - name: Archive linux build
      run: |
        tar -czf combat-tracker-linux.tar.gz -C linux-build .
    - uses: ncipollo/release-action@v1
      with:
        artifacts: "windows-installer/**, combat-tracker-linux.tar.gz"
        bodyFile: "release-body.md"
